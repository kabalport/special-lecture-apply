# 🙋 할일 정리
- 레이어 구현-controller,service,repository,domain,dto
- Mocking해서 단위테스트시작
- 실패케이스들 생각하면서 테스트시나리오 성공케이스와 실패케이스를 작성
- 테스트시나리오 생각하면서 테스트코드 작성
- red-green-refactoring하다가 어느정도 되면 통합테스트로 비즈니스로직테스트
- 동시성 고민> 동시성테스트는 통합테스트에서 구현>실패하는걸 확인하고 green이 되는 조건으로 syncronized로 처리>추후리팩토링(고민을 별로 하지않았음)
  `syncrnozied 로 넣으니 동기성테스트는 성공함, 50초 정도 걸려서 너무 오래 걸리는 느낌`
- 동시성고민2>동시성테스트코드를 작성후에 생각이들었습니다. 충전중일때 같은유저아이디가 또 충전될경우는 충전을 허용해야할까?>> 전혀 그럴필요가 없기때문에 예외처리를 해두었습니다.(”현재 처리중입니다. 잠시후 다시 시도하세요”)라는 throws를 던지도록 수정
- 동시성고민3>그러면 사용자별로 id를 키로하는 Map을 만들것인데 Lock이라는 객체를 사용할수 있다고합니다.
  - `Lock`이라는 객체를 써보지않았고 `ConcurrentHashMap`도 써본적이없지만 일단 담아서 시도
      ```java
      private final ConcurrentHashMap<Long, Lock> locks = new ConcurrentHashMap<>();
      ```
  - `computeIfAbsent` 메서드는 key에 해당하는 값이 있으면 그 값을 반환, 없으면 맵에 추가한후 반환
  - `ReentrantLock`  재진입이 가능한 락 이라고 한다. 락을 기다리는동안 다시 진입할수 있다고 하는데 일단은 보류하고 넘어갔다.
  - 일단은 락휙득실패시에 바로 다시시도하라고 예외를 던져주었다.
  - 그러면 예기치못한오류가 발생했다면, 실패하면 일단 실패한데이터들을 관리가 필요해보여 실패한데이터테이블 에 담아두기로한다.
  - 이러면 일단 실패하더라도 실패한데이터는 관리가 되기때문에, 어떠한이유로 발생했을때 실패데이터는 관리되고있을것이다.
- 리팩토링

# 🙋 갑자기 개발하다가 드는 생각들 정리
`tdd중 red-green-refactoring 중에 red 상황을 어떻게 찾아야 하는가?`

- 현재 고민하다가 생각날때 추가하는게 맞다 생각
- 지금은 ReadMe에 테스트시나리오에 적어두고 red 상황 정리하는 느낌으로 정리

`도메인과 엔티티가 정확히 무엇인가?`

- domain패키지를 만들다가 갑자기 고민했던게 @Entity 붙인클래스 domain 패키지에 두기때문에 고민했던것 같음
- domain 패키지는 그냥 비즈니스에 관련된 핵심로직에 관여된 데이터 모델을 정의,@Entity 붙이 클래스는 데이터베이스에 테이블에 저장되는 데이터구조 모델인데 결은 엄청난게 나눌필요는 없고
- 그냥 domain폴더는 데이터모델들 모아둔곳이라고 정리함
- entity 패키지를 만드는게 더 좋은가 생각되었지만 엄청난 차이는 없을것같아서 @Entity를 붙이더라도 domain패키지에 둘것임

`id pk를 UUID 랜덤처리보다 cursor처리로 자동증가가 더 좋을까?`

- 간단하게 할때는 커서처리로 할듯하다.
- 데이터베이스를 클래스로 구현해서 사용할수 있다는걸 처음 알았음
- 테스트코드를 작성할때 유용하게 보임

`일괄적으로 포인트를 충전한다고할때 A유저랑 B유저가 똑같은시간에 저장된다면 정렬기준은 무엇인지? 아이디가 커서기반이니까 아이디로 정렬하면 되나??`

- 아이디로 정렬할듯
- 둘다 사용하는게 더 좋게 보인다.

`Mock 테스트-성공 테스크코드클래스, Mock 테스트-실패 태스트코드클래스 따로 두는게 좋을듯하게보인다.`

- 왜냐하면 하나의 Mock테스트 모았더니 복잡하다.
> 성공테스트 클래스, 실패테스트클래스를 따로 관리하는게 좋은것인지?
- 처음에 포인트 MockTest 하나의 파일로 두었는데 커질수록 가독성이 안보여서 따로두는게 더 깔끔하지 않을까 생각


# 🙋‍♂️ 과제를 진행하면서 생긴 질문


1. 단위테스트를 작성중에 성공테스트 클래스, 실패테스트클래스를 따로 관리하는게 좋은것인지 궁금합니다
  1. 처음에 포인트 MockTest 하나의 파일로 두었는데 커질수록 가독성이 안보여서 따로두는게 더 깔끔하지 않을까 생각이 들었습니다.

2. 비즈니스로직을 서비스파일에 적고있는데 비즈니스로직에 대한 Exception처리를 PointException클래스를 만들어서 단순히 메시지를 전하는방식으로 구현하였는데 제가생각지도 못한점이 있는지 알고싶습니다.
  1. 예외처리를 하기위해서 RuntimeException을 상속받는 PointException을 만들었습니다.
  2. 그래서 PointException.super(message)메서드를 Service에서 PointException("에러상황") 
     이런식으로 예외가 있다고 생각되면 예외를 던져주는 방식으로 처리하였다.
  3. 내가 단순하게 생각한것인지 더 발전시켜야하는게 있는지 알고싶습니다.

# API
- API - `PointController` : 포인트 api 
- PATCH  `/point/{id}/charge` : 포인트를 충전한다. 
- PATCH `/point/{id}/use` : 포인트를 사용한다. 
- GET `/point/{id}` : 포인트를 조회한다. 
- GET `/point/{id}/histories` : 포인트 내역을 조회한다.

### 주의사항
- 프로젝트에 첨부된 설정 파일은 수정하지 않도록 합니다.
- 테스트 케이스의 작성 및 작성 이유를 주석으로 작성하도록 합니다.
- 프로젝트 내의 주석을 참고하여 필요한 기능을 작성해주세요.
- 분산 환경은 고려하지 않습니다

# 요구사항
- 사용자는 포인트를 충전할수 있습니다.
- 사용자는 포인트를 사용할수 있습니다.
- 사용자는 포인트를 조회할수 있습니다.
- 사용자는 포인트 내역을 조회할수 있습니다.
- 잔고가 부족할 경우, 포인트 사용은 실패하여야 합니다.
- 동시에 여러 건의 포인트 충전, 이용 요청이 들어올 경우 순차적으로 처리되어야 합니다.

# 정리
## TDD 정리
TDD : 테스트가 주도하는 개발을 말함.
TDD는 레드 그린 사이클이라고 보면 된다.(RED-GREEN-REFACTOR)
- red : 항상 실패하는 테스트를 먼저 작성하고
- green : 테스트가 통과하는 프로덕션 코드를 작성
- refactor : 테스트가 통과하면 프로덕션 코드를 리팩토링

>>red 상황을 어떻게 찾아야 하는가?
- 현재 고민하다가 생각날때 추가

## 테스트코드 작성하기 기준
- 가독성 좋은 테스트코드 작성하기
1. 설계 및 시나리오를 잡고 기능에 대한 코드 구현을 구체화
2. 기능 구현을 원하는 요구사항을 검증하는 테스트 추가
3. 테스트를 만족하도록 기능 구현-간단하게 작성했다가 리팩토링하면서 발전시키기
    - 이 때, 테스트는 한번에 많은 Scope 를 잡지 않는다. 이는 불필요한 개발 생산성 저하로 이어진다.
    - 이 시점에서 우리가 몇 배의 시간을 더 투자한다고 해서 테스트 커버리지 100% 를 달성할 수는 없다.
4. 시나리오 구상하기 - Given / when / then 템플릿을 통해 기대 행위에 대한 명세화 초점맞추기
5. 구현된 기능에 대한 리팩토링 ( 인터페이스 구성, 코드클리닝 등 코드 베이스 정리 )
- 기대 행위에 초점을 맞춰서 생각하면 테스트 메소드 각각의 시나리오를 작성하면 수월해진다.
- 성공 케이스 보다는 실패 케이스에 초점
- 정보를 생성할 수 없는 경우에 집중!
- 정보를 생성할 수 없는 에러 케이스들은 어떤 것이 있을까 생각하면, 데이터베이스에서 Schema를 강제 한다거나 타입, 꼴을 강제한다 거나 하는 것들로 이해해볼 수 있습니다. ex. 다음과 같은 경우 '결제 요청'이 불가능하다. (인증 실패,결제 승인,재고 부족,구매불가상품,인가 실패,카드사 점검 시간,카드사 처리 실패,카드가 유효하지 않은 경우 결제 승인 실패,카드의 금액이 부족한 경우 결제 승인 실패
- 모든 코드를 테스트 가능하게 구현하는 것을 목표로 진행합니다.
- 모든 테스트 케이스가 성공했다는 것은 목표한 기능이 완성되었다는 것을 의미합니다.
- 테스트 커버리지 100% 가 아니라, 정확히 기능의 동작을 확인하는 테스트를 작성해 주세요.
- 주요 기능에서 private 접근자, 객체간의 강결합 같이 테스트 불가능한 코드는 가능한 한 지양하는 것이 좋습니다.
- 단순히 테스트 커버리지 100% 를 목표하기보다 기능에 대해 유의미한 테스트케이스를 고민하고 작성하기

# 테스트시나리오
## 끄적끄적 테스트시나리오-단위테스트
- [x] 성공테스트-최초회원의 포인트는 0으로 설정됩니다.
- [x] 실패테스트-포인트충전시 실패한데이터를 실패데이터백업을 합니다.
---
- [x] 성공테스트-포인트충전:사용자는 포인트를 충전할수있습니다
- [x] 실패테스트-포인트충전실패(음수포인트충전시도)

---
- [x] 성공테스트-포인트사용:사용자는 포인트를 사용할수있습니다
- [x] 실패테스트-포인트사용실패(존재하지않는아이디로포인트사용)
- [x] 실패테스트-포인트사용실패(포인트부족)-사용자는 포인트가 부족하여 사용에 실패합니다
    - 잔고가 부족할 경우 PointException message 던져주기
---
- [x] 성공테스트-포인트조회:사용자는 포인트를 조회할수있습니다
- [x] 실패테스트-포인트조회실패(존재하지않는아이디로포인트조회)
---
- [x] 성공테스트-포인트사용내역조회-사용자는 포인트사용내역을 조회할수있습니다
---
## 끄적끄적 테스트시나리오-통합테스트
- [x] 성공테스트-동시성포인트충전-다수의_포인트충전요청시_정확한_포인트증가를_검증합니다
- [x] 성공테스트-동시성포인트사용-다수의_포인트사용요청시_정확한포인트사용을_검증합니다
- [x] 성공테스트-동시성포인트사용-다수의_포인트사용과_충전요청시_정확한_포인트사용을_검증합니다

# 코드 컨벤션
- 도메인에서 할수 있는일은 도메인에서 끝내자 - 고유한 id값 커서처리 등등
- Controller는 Service와 RequestDTO와 ResponseDTO를 사용할수 있다.
- Controller는 Domain을 사용할수 없다.
- Service는 Controller에의해 의존된다.
- Domain은 Service와 Repository에의해 의존된다.
- 테스트코드커버리지-x
- 코드스타일-x

# 컨벤션
## 메인 패키지구조
### point 패키지
- @RestController: controller 패키지에 있어야한다.
- @Service: service 패키지에 있어야한다.
- @Repository : repository 패키지에 있어야한다.
- RequestDTO: dto/request 패키지에 있어야한다.
- ResponseDTO: dto/response 패키지에 있어야한다.
- DOMAIN: domain 패키지에 있어야한다.
### root 패키지
- Exception: exception 패키지에 있어야한다.
- test table: database 패키지에 있어야한다.
- ErrorResponse
- ApiControllerAdvice
>> 도메인은 id로 커서기반으로 자동증가되게 되어있는데 uuid 보다 좋은가?
- 둘다 사용하면 더 좋을듯하다. id는 자동증가되는 키값으로 두고 uuid도 외부로 보여줄 식별자도 두면 더 좋은것 같다.

## 커밋 컨벤션
없음
## 로깅 기준
### [로깅 컨트롤러 컨벤션]
- HTTP 요청 처리,요청경로로그 등등 발생하는 비즈니스이외의 예외로그처리
### [로깅 서비스 컨벤션]
비즈니스 로직과 관련된 오류를 로깅

## 테스트케이스 컨벤션
- DisPlayName에 시작문구넣기(성공테스트-,실패테스트-),뒤에는 행위적기
- 테스트케이스 작성적기 : 테스트 케이스 메소드 위의 주석으로 이 테스트를 간단하게 정의하기
- 테스트케이스 작성이유적기 : 테스트케이스 작성이유를 주석에 적기
- 단위테스트케이스 메서드이름 적기 : 테스트케이스메서드이름적기-행위적기(한글)
- 통합테스트케이스 메서드이름 적기 : 서비스메서드이름과 동일하게, DisplayName에 기능이름을 한글명으로 적자
- 테스트케이스 메서드 주석 : 작성이유랑 작성이름 미리정하고 메서드를 만들자

### [단위테스트 컨벤션]
>> Mock 테스트-성공 테스크코드클래스, Mock 테스트-실패 태스트코드클래스 따로 두는게 좋을듯하게보인다.
- 왜냐하면 하나의 Mock테스트 모았더니 복잡하다.
실패케이스를 이때 많이 만든다.
성공케이스도 메서드가 잘 작동하는지 잘 만든다.
- 메서드 행위 검증 - 메소드 호출이 되었는지 검증
- mock 데이터 검증 - 데이터베이스가 이러한 데이터를 리턴하면 어떻게 할것인지 mock 데이터 검증
- ArgumentCaptor 인자값 검증 - 의도한 대로 동작하면 이러한 인자값이 맞는지 검증
### [통합테스트 컨벤션]
통합테스트기준
- 비즈니스 로직이 잘 수행되는지 적는다.

# 회고1
- TDD라는게 아직 명확하게 잡히지않음
  왜냐하면 회사에서는 테스트코드를 작성하지않았음(예전에 누군가가 했던기록은 남아있었지만 안씀), 지금 필요한 api나 수정해야될때 그때그때 코드보고 로그보고 그 클래스들어가서 수정하거나 만들어서 사용, 그래서 이번에 테스트를 중점으로 개발을 해볼려고했음(몇 번 공부를 시도했던적은 많아서 두루뭉실한 지식은 갖고는 있었음)
  일단 해보면서 정의내리면서 공부하는 스타일이라 내 스스로 정의를 내리고 있는데 명확히 아직 잘 잡히지않았음

- 테스트코드를 작성하면서 드는생각들
  - 데이터의 성공과 실패를 정의해놓기때문에 훨씬 나중에는 편해질것같은 느낌이 듬
  - 컨벤션,주석을 한번 스스로 정의내리면서 하였는데 이게 정작 편한방법인가 생각이 들었음(보통 어떤걸 약속하지?)
    - DisPlayName, 메서드를 한글로하기, 주석을 어떻게하면 깔끔하게 적을수있을까
  - 테스트코드왜 하나의 경우의 수가 있다면 그 경우의 성공,실패, 성공과 실패를 같이인 3가지를 다 테스트해야되나???(ex. 포인트를 충전하다가 오류가 났을때 잘 처리가 되었는지, 포인트를 사용하다가 오류가 났을때 잘처리되었는지, 포인트를 충전 혹은 사용 하다가 오류가 났을때 잘 처리가 되었는지)>> 내 생각에는 많으면 많을수록 좋은것 같은데 그렇다면 그 기준은 무엇인가..라는 생각과..일단 작게작게 쪼개서 하는게 좋을까..
  - 목업테스트에서 다 테스트했는데 통합테스트해도 똑같이 전부 테스트 해야되나??
  - 그리고 테스트코드량이 한 파일에 많아지면 많아질수록 내가 이 테스트코드를 했는지 잘 보이지않는다. 그래서 일단은 마크다운에 적으면서 했거나 안했거나 해야될것들을 정리하는 느낌으로 하고있다.
  - 생각날때마다 테스트할거 리드미에 적어둠
  - 컨트롤러테스트도 해보고싶은데, 컨트롤러테스트가 급한건 아닌것같아서 미룸.내 생각엔 서비스테스트,단위,통합,리팩토링,예외처리,그리고 엄청난 고민후 다 되면 컨트롤러테스트하고 컨트롤러가 완성되는게 테스트기반에 더가깝지않을까 생각이 들었음
  - 본격적으로 테스트를 주도로 개발을 해보자한건 처음이라 경험이 없어서 손발이 더 고생하는느낌이기도함
  - 이전에는 디비연결은 이미 해놓았으니 api호출시켜보면서 작업을 했는데 테스트를 시나리오 기반으로 개발을 해보니 내가 하지못한 테스트가 있나 하나하나 전부의심됨. 어차피 작업후 postman으로 던져보기까지하는게 좋아보여서 postman api까지는 던져봐야한다고는 생각함

